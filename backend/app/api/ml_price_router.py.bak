import os
from typing import Optional, Any, Dict
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from app.ml.predictor import load_model, predict_one

router = APIRouter(prefix="/ml/price", tags=["ml:price"])

MODEL_PATH = os.path.abspath(os.getenv("AQARAK_MODEL_PATH", "models/aqarak_price_model_latest.joblib"))
FURNISHED_CAP_APT = float(os.getenv("APT_FURNISHED_CAP", "0.02")) 

_MODEL = None

class PriceInput(BaseModel):
    bedrooms: Optional[float] = None
    bathrooms: Optional[float] = None
    area_sqm: Optional[float] = None
    floor: Optional[float] = None
    building_age: Optional[Any] = None
    city: Optional[str] = None
    neighborhood: Optional[str] = None
    property_type: Optional[str] = None
    furnished: Optional[bool] = None

class PriceOutput(BaseModel):
    price_jod: float

@router.on_event("startup")
def _init_model():
    global _MODEL
    _MODEL = load_model(MODEL_PATH)

def _predict_apartment_capped(payload: Dict[str, Any]) -> float:
    base = {k: v for k, v in payload.items() if v is not None}
    pt = str(base.get("property_type", "")).strip().title()
    if pt != "Apartment":
        return float(predict_one(_MODEL, base))

    p_t = dict(base); p_t["furnished"] = True
    p_f = dict(base); p_f["furnished"] = False
    y_t = float(predict_one(_MODEL, p_t))
    y_f = float(predict_one(_MODEL, p_f))

    mid = 0.5 * (y_t + y_f)
    cap = FURNISHED_CAP_APT * max(1.0, mid)   # max Â±cap around midpoint
    delta = y_t - y_f
    used = max(-cap, min(cap, delta))

    return float(y_f + used) if base.get("furnished", False) else float(y_t - used)

@router.post("/predict", response_model=PriceOutput)
def predict_price(inp: PriceInput):
    if _MODEL is None:
        raise HTTPException(status_code=500, detail="Model not loaded")
    miss = [k for k in ("area_sqm", "city", "property_type") if getattr(inp, k) is None]
    if miss:
        raise HTTPException(status_code=400, detail=f"missing fields: {miss}")

    try:
        y = _predict_apartment_capped(inp.dict())
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
    return PriceOutput(price_jod=float(max(0.0, y)))